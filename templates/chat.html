<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Чат с {{ other_user.username }}</title>
</head>
<body>
    <h1>Чат с {{ other_user.username }}</h1>

    <div id="messages" style="height: 400px; overflow-y: auto;">
  {% for msg in messages %}
    <p><strong>{{ msg.sender.username }}:</strong> {{ msg.body }}</p>
  {% endfor %}
</div>

<!--    <div style="border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll;">-->
<!--        {% for msg in messages %}-->
<!--            <p>-->
<!--                <strong>-->
<!--                    {% if msg.sender_id == current_user.id %}-->
<!--                        Ты:-->
<!--                    {% else %}-->
<!--                        {{ other_user.username }}:-->
<!--                    {% endif %}-->
<!--                </strong>-->
<!--                {{ msg.body }}-->
<!--                <br>-->
<!--                <small>{{ msg.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</small>-->
<!--            </p>-->
<!--            <hr />-->
<!--        {% endfor %}-->
<!--    </div>-->

    <form method="post">
        <textarea name="message" rows="3" cols="40" required></textarea><br />
        <button type="submit">Отправить</button>
    </form>

    <p><a href="{{ url_for('chat') }}">Назад к списку чатов</a></p>
    <p><a href="{{ url_for('logout') }}">Выйти</a></p>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
<script>
    const socket = io();

    // При подключении отправляем серверу, кто мы (чтобы присоединиться к своей комнате)
    socket.emit('join', { user_id: {{ current_user.id }} });

    // Отправка сообщения по сокету
    document.querySelector('form').addEventListener('submit', function(e) {
        e.preventDefault();
        const input = this.querySelector('textarea[name="message"]');
        const message = input.value.trim();
        if (!message) return;

        socket.emit('send_message', {
            message: message,
            recipient_id: {{ other_user.id }}
        });

        input.value = '';
    });

    // Получение сообщения
    socket.on('receive_message', function(data) {
        const chatDiv = document.getElementById('messages'); // контейнер с сообщениями
        const p = document.createElement('p');
        p.innerHTML = `<strong>${data.username}:</strong> ${data.message}`;
        chatDiv.appendChild(p);
        chatDiv.scrollTop = chatDiv.scrollHeight; // автопрокрутка вниз
    });
</script>

</body>
</html>
